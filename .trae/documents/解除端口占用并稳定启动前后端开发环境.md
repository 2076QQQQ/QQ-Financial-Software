## 现状诊断
- 前端开发端口：`frontend/package.json` 指定 `next dev -p 3000`
- 后端监听端口：`backend/server.ts:387` 指向 `server.listen(4000)`
- 前端代理重写：`frontend/next.config.js` 将 `/api/*` 代理到 `http://localhost:4000/api/*`
- 同时启动：根目录 `package.json` 使用 `concurrently` 同时跑前后端
- 报错现象：`EADDRINUSE` 显示 `3000` 与 `4000` 都被占用；Next 还提示 `Invalid source map`（通常由 `.next` 缓存/依赖源映射不规范引起，非致命）

## 原因说明
- 为避免前后端端口冲突，后端端口已统一改为 `4000`，前端继续用默认 `3000`，并通过 `next.config.js` 代理到后端。这是常见的本地开发端口布局。
- 当前失败的直接原因是这两个端口已被其他进程占用（可能是之前遗留的 node/next/ts-node 进程）。

## 执行步骤
### 步骤 1：释放占用端口
- 查询占用 `3000` 的进程：`netstat -ano | findstr :3000`
- 查询占用 `4000` 的进程：`netstat -ano | findstr :4000`
- 强制结束对应 PID：`taskkill /PID <PID> /F`
- 如提示无权限，使用管理员 PowerShell 运行上述命令。

### 步骤 2：清理前端缓存
- 在 `frontend` 目录删除 `.next` 缓存，避免源映射/旧构建影响：`Remove-Item -Recurse -Force .next`

### 步骤 3：按既定端口启动
- 保持当前布局：前端 `3000`，后端 `4000`（与现有 `next.config.js` 完全匹配）。
- 从根目录运行：`npm run dev`（内部会并发启动 `backend` 与 `frontend`）。

### 可选方案：若仍然端口冲突
- 备选端口：后端改为 `5050` 并同步更新 `frontend/next.config.js` 代理为 `http://localhost:5050/api/:path*`；前端继续 `3000`。
- 或前端改为 `3001`：`next dev -p 3001`，保持后端 `4000`，并正常代理。

## 验证与排查
- 打开 `http://localhost:3000/` 应进入登录入口；
- 在浏览器开发者工具 Network 验证：调用 `/api/*` 请求被代理到 `http://localhost:4000/api/*` 并返回 200/401 等正常状态；
- 若仍出现 `Invalid source map` 提示但服务可启动，可忽略；若影响启动，清理 `.next` 后重试。

## 说明与承诺
- 端口变为 `4000` 是为了与前端 `3000` 解耦，避免同端口抢占；当前代码已按该布局配置完成（监听与代理一致）。
- 获得确认后，我将：
  - 终止占用 `3000/4000` 的进程并清理缓存；
  - 重新启动并验证页面与 API；
  - 如仍异常，切换到备选端口并同步更新配置。